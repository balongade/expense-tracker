{% extends "base.html" %}
{% block title %}Expenses{% endblock %}
{% block content %}

<!-- Chart -->
<div class="card my-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Savings vs Spending</span>
    <span class="fw-bold text-primary">
      Total: ₱{{ "{:,.2f}".format(total) }}
    </span>
  </div>
    <div class="card-body">
      <div style="position: relative; height:40vh; width:100%">
        <canvas id="typeChart"></canvas>
      </div>
    </div>
</div>

<script>
  const chartData = {
    months: {{ months|tojson }},
    savings: {{ savings_data|tojson }},
    spending: {{ spending_data|tojson }}
  };
</script>

<!-- Table -->
<div class="table-responsive">
    <table class="table table-striped table-bordered table-fixed">
        <thead class="table-light">
            <tr>
                <th>#</th><th>Date</th><th>Type</th><th>Category</th>
                <th>Amount</th><th>Description</th><th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for exp in expenses %}
            <tr>
                <td>{{ (page - 1) * 10 + loop.index }}</td>
                <td>{{ exp.date|datetimeformat }}</td>
                <td>{{ exp.type }}</td>
                <td>{{ exp.category }}</td>
                <td>₱{{ "{:,.2f}".format(exp.amount) }}</td>
                <td>{{ exp.description }}</td>
                <td>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="actionMenu{{ exp.id }}"
                            data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="actionMenu{{ exp.id }}">
                      <li>
                        <a class="dropdown-item" href="{{ url_for('edit', id=exp.id) }}">Edit</a>
                      </li>
                      <li>
                        <!-- Trigger reusable modal -->
                        <button class="dropdown-item text-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#confirmDeleteModal"
                                data-id="{{ exp.id }}"
                                data-description="{{ exp.description }}"
                                data-amount="{{ "{:,.2f}".format(exp.amount) }}">
                          Delete
                        </button>
                      </li>
                    </ul>
                  </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<!-- Pagination -->
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    {% if page > 1 %}
      <li class="page-item"><a class="page-link" href="{{ url_for('index', page=page-1) }}">Previous</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}

    {% for p in range(1, total_pages+1) %}
      <li class="page-item {% if p == page %}active{% endif %}">
        <a class="page-link" href="{{ url_for('index', page=p) }}">{{ p }}</a>
      </li>
    {% endfor %}
    {% if page < total_pages %}
      <li class="page-item"><a class="page-link" href="{{ url_for('index', page=page+1) }}">Next</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>
<!-- Reusable Delete Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmDeleteLabel">Warning</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ⚠️ Are you sure you want to delete this expense?<br>
        <strong id="deleteDescription"></strong> — ₱<span id="deleteAmount"></span>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <a id="deleteConfirmBtn" href="#" class="btn btn-danger">Yes, Delete</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}