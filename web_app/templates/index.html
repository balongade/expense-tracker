{% extends "base.html" %}
{% block title %}Expenses{% endblock %}
{% block content %}

<!-- Chart -->
<div class="card my-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Savings vs Spending</span>
    <span class="fw-bold text-primary">
      Total: ₱{{ "{:,.2f}".format(total) }}
    </span>
  </div>
    <div class="card-body">
      <div style="position: relative; height:40vh; width:100%">
        <canvas id="typeChart"></canvas>
      </div>
    </div>
</div>

<script>
    const ctx = document.getElementById('typeChart').getContext('2d');
    const typeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ months|tojson }},
            datasets: [
                {
                    label: 'Savings',
                    data: {{ savings_data|tojson }},
                    borderColor: 'blue',
                    backgroundColor: 'rgba(0, 0, 255, 0.2)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Spending',
                    data: {{ spending_data|tojson }},
                    borderColor: 'green',
                    backgroundColor: 'rgba(0, 128, 0, 0.2)',
                    fill: true,
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                datalabels: {
                    color: '#7f7f7f',
                    align: 'top',
                    formatter: function(value, context) {
                        const monthIndex = context.dataIndex;
                        const savings = {{ savings_data|tojson }}[monthIndex];
                        const spending = {{ spending_data|tojson }}[monthIndex];
                        const total = savings + spending;
                        if (total === 0) return '';
                        const percent = Math.round((value / total) * 100);
                        return percent + '%';
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: value => '₱' + value }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
</script>

<!-- Table -->
<div class="table-responsive">
    <table class="table table-striped table-bordered table-fixed">
        <thead class="table-light">
            <tr>
                <th>#</th><th>Date</th><th>Type</th><th>Category</th>
                <th>Amount</th><th>Description</th><th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for exp in expenses %}
            <tr>
                <td>{{ (page - 1) * 10 + loop.index }}</td>
                <td>{{ exp.Date }}</td>
                <td>{{ exp.Type }}</td>
                <td>{{ exp.Category }}</td>
                <td>₱{{ "{:,.2f}".format(exp.Amount) }}</td>
                <td>{{ exp.Description }}</td>
                <td>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="actionMenu{{ exp.id }}"
                            data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="actionMenu{{ exp.id }}">
                      <li>
                        <a class="dropdown-item" href="{{ url_for('edit', id=exp.id) }}">Edit</a>
                      </li>
                      <li>
                        <a class="dropdown-item text-danger" href="{{ url_for('delete', id=exp.id) }}">Delete</a>
                      </li>
                    </ul>
                  </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    {% if page > 1 %}
      <li class="page-item"><a class="page-link" href="{{ url_for('index', page=page-1) }}">Previous</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}

    {% for p in range(1, total_pages+1) %}
      <li class="page-item {% if p == page %}active{% endif %}">
        <a class="page-link" href="{{ url_for('index', page=p) }}">{{ p }}</a>
      </li>
    {% endfor %}

    {% if page < total_pages %}
      <li class="page-item"><a class="page-link" href="{{ url_for('index', page=page+1) }}">Next</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>
{% endblock %}