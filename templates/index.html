{% extends "base.html" %}
{% block title %}Expenses{% endblock %}
{% block content %}

<div class="row my-2 g-1">
  <!-- Savings vs Spending Chart -->
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-header">
        <span>Savings vs Spending</span>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height:370px;">
          <canvas id="typeChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Monthly Category Totals Table -->
  <div class="col-md-9">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Monthly Category Totals</span>
        <span class="fw-bold text-primary">
          Total: ₱{{ "{:,.2f}".format(total) }}
        </span>
      </div>
      <div class="card-body">
        <div class="table-responsive" style="height:380px;">
          <table class="table table-bordered table-sm align-middle text-start table-fix" style="font-size:12px;">
            <thead>
              <tr class="text-start">
                <th>Category</th>
                {% for month in table_months %}
                  <th>{{ month }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for category in all_categories %}
                <tr class="text-start">
                  <td>{{ category }}</td>
                  {% for month in table_months %}
                    <td>
                      {{ monthly_category_totals.get(month, {}).get(category) or "" }}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const chartData = {
    months: {{ months|tojson }},
    savings: {{ savings_data|tojson }},
    spending: {{ spending_data|tojson }}
  };
</script>

<!-- Expenses Table -->
<div class="table-responsive">
  <table class="table table-striped table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th scope="col" class="col-index">#</th>
        <th scope="col" class="col-date">Date</th>
        <th scope="col" class="col-type">Type</th>
        <th scope="col" class="col-category">Category</th>
        <th scope="col" class="col-amount">Amount</th>
        <th scope="col" class="col-description">Description</th>
        <th scope="col" class="col-action">Action</th>
      </tr>
    </thead>
    <tbody>
      {% for exp in expenses %}
      <tr>
        <td class="col-index">{{ (page - 1) * 10 + loop.index }}</td>
        <td class="col-date">{{ exp.date|datetimeformat }}</td>
        <td class="col-type">{{ exp.type }}</td>
        <td class="col-category">{{ exp.category }}</td>
        <td class="col-amount">{{ "{:,.2f}".format(exp.amount) }}</td>
        <td class="col-description">{{ exp.description }}</td>
        <td class="col-action">
          <div class="dropdown">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button"
                    id="actionMenu{{ exp.id }}" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="actionMenu{{ exp.id }}">
              <li>
                <a class="dropdown-item" href="{{ url_for('edit', id=exp.id) }}">Edit</a>
              </li>
              <li>
                <button class="dropdown-item text-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#confirmDeleteModal"
                        data-id="{{ exp.id }}"
                        data-description="{{ exp.description }}"
                        data-amount="{{ "{:,.2f}".format(exp.amount) }}">
                  Delete
                </button>
              </li>
            </ul>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination -->
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    <li class="page-item {% if page <= 1 %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('index', page=page-1) }}" tabindex="-1">Previous</a>
    </li>
    {% for p in range(1, total_pages+1) %}
      <li class="page-item {% if p == page %}active{% endif %}">
        <a class="page-link" href="{{ url_for('index', page=p) }}" {% if p == page %}aria-current="page"{% endif %}>
          {{ p }}
        </a>
      </li>
    {% endfor %}
    <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('index', page=page+1) }}">Next</a>
    </li>
  </ul>
</nav>

<!-- Reusable Delete Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmDeleteLabel">Warning</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmDeleteBody">
        ⚠️ Are you sure you want to delete this expense?<br>
        <strong id="deleteDescription"></strong> — ₱<span id="deleteAmount"></span>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <a id="deleteConfirmBtn" href="#" class="btn btn-danger">Yes, Delete</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}